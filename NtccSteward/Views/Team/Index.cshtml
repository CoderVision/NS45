@model NtccSteward.ViewModels.Team.TeamIndexViewModel

<div id="teamRoot" ng-app="App" ng-controller="TeamController" ng-init="init('@Model.ChurchId', '@Model.Title','@Model.Api')">

    @{
        ViewBag.Title = @Model.Title;
    }

    <span class="sectionTitle">{{title}}</span>

    <form class="form-inline">
        <input type="search" id="teamSearch" class="form-control" style="padding:3px;width:300px;margin-bottom:4px;margin-left:0px;" placeholder="Team Name Search"
                oninput="FilterTable('teamTbl', this.value, 'Team Name')" />
        <button type="button" class="btn btn-primary addBtn" data-toggle="modal" data-target="#newTeam" style="margin-left:8px;margin-bottom:4px;padding-bottom:2px;">
            <span class="glyphicon glyphicon-plus glyphicon-btn"></span> Add
        </button>
    </form>

    <table id="teamTbl" class="table table-sm table-hover table-bordered">
        <thead class="thead-default">
            <tr>
                <th class="text-center">
                    Team Name
                </th>
                <th class="text-center">
                    Team Leader
                </th>
                <th class="hideXs text-center">
                    Description
                </th>
                <th class="hideXs text-center">
                    Type
                </th>
                <th class="hideXs">
                    &nbsp;
                </th>
            </tr>
        </thead>
        <tbody id="teamTblBody" ng-repeat="team in teamList">
            <tr>
                <td>
                    <a href="~/Team/Edit/{{team.id}}">{{team.name}}</a>
                </td>
                <td>
                    team leader
                </td>
                <td class="hideXs">
                    {{team.desc}}
                </td>
                <td class="hideXs">
                    {{team.teamTypeEnumDesc}}
                </td>
                <td class="text-center hideXs" style="vertical-align:middle;">
                    <i class="glyphicon glyphicon-remove glyphicon-remove-grid" ng-click="deleteTeam(team.id)"></i>
                </td> 
            </tr>
        </tbody>
    </table>


    <div class="modal fade" id="newTeam" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 id="addMbrTitle" class="modal-title ">Add Team</h4>
                </div>
                <div class="modal-body">
                    <form class="form" id="addTeamForm">
                        <div class="form-group">
                            <label for="name" class="labelNormal">Name</label>
                            <input type="text" class="form-control" id="name" name="name" placeholder="Enter name" ng-model="EditTeam.name" />
                        </div>
                        <div class="form-group">
                            <label for="desc" class="labelNormal">Description</label>
                            <input type="text" class="form-control" id="desc" name="desc" placeholder="Enter description" ng-model="EditTeam.desc" />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" ng-click="addTeam()">Save &amp; Add Another</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{

    <script type="text/javascript">

        var appModule = angular.module('App', []);

        appModule.controller('TeamController', ['$scope', '$http', function ($scope, $http) {

            $scope.init = function (churchId, title, apiUrl) {
                $scope.churchId = churchId;
                $scope.title = title;
                $scope.apiUrl = apiUrl;
                $scope.EditTeam = new $scope.Team("", "", "", "", "", "");

                // automatically load list
                $scope.loadList();
            }

            $scope.churchId;

            $scope.title = "Teams";

            $scope.apiUrl;

            $scope.teamList = [];

            $scope.memberList = [];

            $scope.EditTeam = null;

            $scope.Team = function(id,name,desc,churchId,teamTypeEnumId,teamPositionEnumTypeId)
            {
                this.id = id;
                this.name = name;
                this.desc = desc;
                this.churchId = churchId;
                this.teamTypeEnumId = teamTypeEnumId;
                this.teamPositionEnumTypeId = teamPositionEnumTypeId;
            }

            $scope.loadList = function()
            {
                //http://localhost:62428/church/3/team
                var uri = $scope.apiUrl + "church/" + $scope.churchId + "/team";
                $http.get(uri)
                    .then(
                        function (response) {

                            var list = $.map(response.data, function (item) { return new $scope.Team(item.id, item.name, item.desc, item.churchId, item.teamTypeEnumId, item.teamPositionEnumTypeId) })

                            $scope.teamList = list;

                            $("#teamTblBody").show();
                        }
                        , function (error) {
                            console.log("loadList error: " + error);
                        }
                );
            }

            $scope.deleteTeam = function(id)
            {
                //http://localhost:62428/church/3/team
                var uri = $scope.apiUrl + "team/" + id;
                $http.delete(uri)
                    .then(
                        function (response)
                        {
                            // remove element from list
                            var t = $scope.teamList.find(function (team) {
                                if (team.id == id)
                                    return team;
                                else
                                    return null;
                            });
                            if (t)
                            {
                                var idx = $scope.teamList.indexOf(t);
                                $scope.teamList.splice(idx,1);
                            }
                        }
                         , function (error) {
                             console.log("deleteTeam error: " + error);
                         }
                    );
            }

            $scope.addTeam = function () {
                
                var newTeam = $scope.EditTeam;
                newTeam.churchId = $scope.churchId;
                newTeam.teamTypeEnumId = 69;  // default to evangelist until we get other team types
                newTeam.teamPositionEnumTypeId = 18; // EvangelicalTeamPositionType (team leader, team member)
                
                var uri = $scope.apiUrl + "team";
                $.ajax({
                    type: "POST",
                    datatype: "JSON",
                    data: newTeam,
                    url: uri,
                    success: function (data) {

                        var t = data;
                        var team = new $scope.Team(t.id, t.name, t.desc, t.churchId, t.teamTypeEnumId, t.teamPositionEnumTypeId);

                        $scope.teamList.push(team);

                        $scope.EditTeam.name = "";
                        $scope.EditTeam.desc = "";

                        $scope.apply();
                    },
                    error: function (xhr, asaxOptions, thrownError) {

                        alert(xhr.responseText);

                    }
                    , context: this
                });
            }
        }]);

    </script>
}
